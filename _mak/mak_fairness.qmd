---
title: "Make auROCs for Model Fairness Evaluations"
author: "Kendra Wyant"
date: "`r lubridate::today()`"
output: 
  html_document:
    toc: true 
    toc_depth: 4
format:
  html:
    embed-resources: true
params:
  
  study: "combined"
  model: "dyn_dem_oud" 
  version: "v8"
editor_options: 
  chunk_output_type: console
---

### Set Up Environment

```{r}
study <- params$study
model <- params$model
version <- params$version
```


Packages, functions, and paths
```{r}
#| message: false
#| warning: false

library(tidyverse)
library(tidymodels)
options(conflicts.policy = "depends.ok")

devtools::source_url("https://github.com/jjcurtin/lab_support/blob/main/format_path.R?raw=true")

path_shared <- format_path(str_c("risk2/data_processed/shared"))
path_models <- format_path(str_c("risk2/models/", study))
```


### Load model predictions

```{r}
preds <- read_rds(here::here(path_models, str_c("preds_xgboost_kfold_6_x_5_", version, 
                                                "_", model, ".rds")))
```

### Load fairness features

```{r}
labels <- read_csv(here::here(path_shared, "lapse_labels_1day_gps.csv"),
                   show_col_types = FALSE)

dem <- read_csv(here::here(path_shared, "features_fairness.csv"),
                 show_col_types = FALSE) |>
  select(-ruca1) |> 
  filter(subid %in% labels$subid)
```

### Link features with predictions

```{r}
feat_preds <- labels |> 
  select(id_obs = label_num,
         label = lapse,
         subid) |>
  right_join(preds, by = c("id_obs", "label")) |> 
  mutate(label = factor(label, levels = c("Lapse", "No lapse"))) |> 
  left_join(dem, by = "subid")

# nrow(feat)
# nrow(preds) # should be nrow(feat) * 6 (number of outer repeats)
# nrow(feat_preds) # should be same as nrow(preds)
```


### Calculate auROCs by group

This calculates auROC using test sets and raw probabilities.   

function
```{r}
get_auroc_by_dem <- function(df, var) {
  # df should be dataframe with demographic features and predictions
  # var should be character or factor variable in df
  
  var_tmp <- df |> 
      pull(get(var))
   
  var_levels <- 
     if (class(var_tmp) != "factor") {
       levels(as.factor(var_tmp))
     } else levels(var_tmp)
  
  # create empty tibble with split nums
  auroc <- tibble(split_num = unique(df$split_num)) |> 
    arrange(split_num) 
    
  for (level in var_levels) {
     auroc_level <- df |>
       filter(get(var) == level) |> 
       nest(.by = split_num, .key = "preds") |> 
       mutate(auroc = map(preds, \(preds) roc_auc(preds, prob_raw, 
                                             truth = label))) |> 
       select(-preds) |> 
       unnest(auroc) |> 
       select(-c(.estimator, .metric)) |> 
       rename(!!level:=.estimate)
     
     auroc <- auroc |> 
       left_join(auroc_level, by = "split_num")
  }
  
  return(auroc)
}
```


get auROCs 
```{r}
auroc_dem <- get_auroc_by_dem(df = feat_preds, var = "gender") |> 
  left_join(get_auroc_by_dem(df = feat_preds, var = "race"), by = "split_num") |> 
  left_join(get_auroc_by_dem(df = feat_preds, var = "income"), by = "split_num") |> 
  left_join(get_auroc_by_dem(df = feat_preds, var = "geography"), by = "split_num")  |> 
  left_join(get_auroc_by_dem(df = feat_preds, var = "education"), by = "split_num")  
```


Save auroc_dem
```{r}
auroc_dem |> 
  write_csv(here::here(path_models, str_c("fairness_auroc_xgboost_6_x_5_kfold_", 
                                          version, "_", 
                                          model, ".csv")))  
```
